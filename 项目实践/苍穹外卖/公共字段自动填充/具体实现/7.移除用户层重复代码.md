
经过前面六个步骤的铺垫，我们已经成功构建并激活了 `AutoFillAspect`。现在，这个切面会在 `Mapper` 层的 `insert` 和 `update` 方法执行前，==自动==、==透明==地完成公共字段的填充。

因此，最后一步就是回到最初的“痛点”所在——`Service` 层，将那些手动设置公共字段的“样板代码”==彻底移除==。

## 1. 目标代码

我们在 [[项目实践/苍穹外卖/公共字段自动填充/需求分析|需求分析]] 中已经看到，`EmployeeServiceImpl` 和 `CategoryServiceImpl` 等类中存在类似的重复代码块。

> [!EXAMPLE] Service 层原始重复代码 (示例)
> ```java
> //        employee.setCreateTime(LocalDateTime.now());
> //        employee.setUpdateTime(LocalDateTime.now());
> //
> //        employee.setCreateUser(BaseContext.getCurrentId());
> //        employee.setUpdateUser(BaseContext.getCurrentId());
> ```
>

## 2. 执行移除

确认 `AutoFillAspect` 正常工作后（可以通过 Debug 或查看数据库确认字段已自动填充），大胆地**删除**或**注释掉** `Service` 实现类中所有手动设置 `createTime`, `updateTime`, `createUser`, `updateUser` 的代码行。

> [!EXAMPLE] 清理后的 Service 代码 (EmployeeServiceImpl 示例)
> ```java
> @Service
> public class EmployeeServiceImpl implements EmployeeService {
>
>     @Autowired
>     private EmployeeMapper employeeMapper;
>
>     // ... login 方法 ...
>
>     @Override
>     public void addEmployee(EmployeeDTO employeeDTO) {
>         Employee employee = new Employee();
>         BeanUtils.copyProperties(employeeDTO, employee);
>
>         //设置账号的状态，密码，默认为1 正常状态, 0 锁定状态
>         employee.setPassword(DigestUtils.md5DigestAsHex(PasswordConstant.DEFAULT_PASSWORD.getBytes()));
>         employee.setStatus(StatusConstant.ENABLE);
>
>         // == 公共字段赋值逻辑已被移除 ==
>         // == 现在由 AutoFillAspect 自动处理 ==
>
>         employeeMapper.insert(employee);
>     }
>
>     @Override
>     public void updateEmployee(EmployeeDTO employeeDTO) {
>         Employee employee = new Employee();
>         BeanUtils.copyProperties(employeeDTO, employee);
>
>         // == 公共字段赋值逻辑已被移除 ==
>         // == 现在由 AutoFillAspect 自动处理 ==
>         // employee.setUpdateTime(LocalDateTime.now()); // 不再需要
>         // employee.setUpdateUser(BaseContext.getCurrentId()); // 不再需要
>
>         employeeMapper.updateEmployee(employee); // updateEmployee 方法已标记 @AutoFill(UPDATE)
>     }
>
>     // ... 其他方法 ...
> }
> ```
>

> [!NOTE] 核心解析
> 通过将公共字段填充的逻辑**下沉**到 AOP 切面中，`Service` 层的代码变得更加==简洁==、==聚焦于业务逻辑==。
>
> - **==代码量减少==**：移除了大量的重复赋值代码。
> - **==可维护性提高==**：如果未来公共字段的填充逻辑需要变更（例如时间格式、用户ID来源），只需要修改 `AutoFillAspect` 一个地方，而不需要改动每一个 `Service` 类。
> - **==业务逻辑更清晰==**：`Service` 方法不再被非核心业务的“噪音”干扰。

> [!TIP] 验证
> 移除代码后，务必通过**测试**（单元测试或集成测试）来验证：
> 1. 新增操作时，`create_time`, `update_time`, `create_user`, `update_user` 均已正确填充。
> 2. 修改操作时，`update_time`, `update_user` 已正确更新。
> 3. 不需要自动填充的操作（如查询）没有受到影响。

---
**返回MOC：**
[[项目实践/苍穹外卖/公共字段自动填充/实现 (MOC)|实现 (MOC)]]