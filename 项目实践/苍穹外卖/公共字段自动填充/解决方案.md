# 解决方案：AOP + 反射

## 1. 核心思想 (What)

针对 [[项目实践/苍穹外卖/公共字段自动填充/需求分析|需求分析]] 中提到的“样板代码”重复问题，最佳解决方案是采用 [[知识库/spring框架/AOP(面向切面编程)/AOP (MOC)|AOP (MOC)]] 的思想。

- **为什么是 AOP？**：公共字段填充（如 `createTime`, `updateUser`）是一个典型的**横切关注点 (Cross-Cutting Concern)**。它“横切”了多个业务模块（员工管理、分类管理、菜品管理...），但它本身不属于任何一个模块的核心业务。AOP 就是专门用来优雅地处理这类问题的。

- **方案**：我们将创建一个 AOP 切面 `AutoFillAspect`，让它“潜入”到我们的 `Mapper` 层方法执行之前，“悄悄地”帮我们完成字段填充，而 `Service` 层和 `Mapper` 层对此**毫不知情**。

## 2. 拦截点选择 (Where)

我们有两种选择：拦截 `Service` 层方法，还是拦截 `Mapper` 层方法。

- **拦截 `Service` 层（不推荐）**：
    - 优点：能拿到 `EmployeeDTO` 等原始对象。
    - 缺点：`Service` 层的方法名五花八门（`save`, `addEmployee`, `updateStatus`...），拦截规则难以统一。
- **拦截 `Mapper` 层（推荐）**：
    - 优点：`Mapper` 层是最终执行数据库操作的地方，逻辑最纯粹（`insert`, `update`）。
    - 优点：`MyBatis` 的 `Mapper` 方法（如 `insert(Employee employee)`）接收的参数**已经是实体对象 `Employee`**，非常适合我们进行反射操作。

**结论**：我们将 AOP 切面应用在 `com.sky.mapper` 包下的方法。

## 3. 高层实现组件 (How)

为了实现这个方案，我们需要以下几个关键组件协同工作（对应 [[项目实践/苍穹外卖/公共字段自动填充/实现 (MOC)|实现 (MOC)]] 中的步骤）：

1.  **一个“标记”**：我们不能拦截 `Mapper` 下的所有方法（比如 `select` 方法就不需要填充）。我们需要一个“标记”来告诉 AOP 应该拦截哪些方法。
    - **技术选型**：[[知识库/java基础/Java-注解(Annotation)/Java-注解-自定义注解|Java-注解-自定义注解]]
    - **笔记链接**：[[项目实践/苍穹外卖/公共字段自动填充/具体实现/1.定义注解@AutoFill|1.定义注解@AutoFill]]

2.  **一个“操作类型”**：`INSERT` 和 `UPDATE` 操作的填充逻辑不同（`INSERT` 填4个字段，`UPDATE` 填2个字段）。我们的“标记”必须能区分这两种操作。
    - **技术选型**：[[知识库/java基础/Java-枚举(Enum)|Java-枚举(Enum)]]
    - **笔记链接**：[[项目实践/苍穹外卖/公共字段自动填充/具体实现/2.定义枚举类OperationType|2.定义枚举类OperationType]]

3.  **一个“拦截器”**：这是 AOP 的核心，负责定义“拦截谁”和“做什么”。
    - **技术选型**：[[知识库/spring框架/AOP(面向切面编程)/AOP (MOC)|AOP (MOC)]]
    - **笔记链接**：[[项目实践/苍穹外卖/公共字段自动填充/具体实现/3.定义AOP切面(Pointcut)|3.定义AOP切面(Pointcut)]] 和 [[项目实践/苍穹外卖/公共字段自动填充/具体实现/4.实现AOP通知(before)|4.实现AOP通知(before)]]

4.  **一个“动态赋值工具”**：拦截器拿到的参数是 `Object` 类型的实体（可能是 `Employee` 或 `Category`），它需要一种通用的方式来调用 `setCreateTime` 等方法。
    - **技术选型**：[[知识库/java基础/Java-反射/Java-反射 (MOC)|Java-反射 (MOC)]]
    - **笔记链接**：[[项目实践/苍穹外卖/公共字段自动填充/具体实现/5.反射调用|5.反射调用]]

5.  **一个“数据传递工具”**：`create_user` 和 `update_user` 需要“当前登录用户的ID”。这个ID在 `Interceptor` 层 被解析，但 `Aspect` 层在另一个地方。我们需要一个工具在同一次请求线程中“隔空”传递数据。
    - **技术选型**：[[知识库/java基础/ThreadLocal|ThreadLocal]]
    - **笔记链接**：[[项目实践/苍穹外卖/公共字段自动填充/具体实现/6.ThreadLocal传递用户ID|6.ThreadLocal传递用户ID]]

---
**下一步：**
[[项目实践/苍穹外卖/公共字段自动填充/实现 (MOC)|实现 (MOC)]]